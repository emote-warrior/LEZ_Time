import os
import requests
import pandas as pd
from datetime import datetime

# Your Google API key
API_KEY = os.getenv('GOOGLE_MAPS_API_KEY')

# List of origin and destination pairs
locations = [
    # Entry pairs
    ('28.63615,77.2139416666667', '28.6333388888889,77.1999305555556'),
    ('28.6333388888889,77.1999305555556', '28.6466638888889,77.1952611111111'),
    ('28.6468611111111,77.2099861111111', '28.6282333333333,77.2051083333333'),
    ('28.6282333333333,77.2051083333333', '28.6445055555556,77.1995777777778'),
    ('28.6408388888889,77.213375', '28.6294194444444,77.2082111111111'),
    ('28.6294194444444,77.2082111111111', '28.6427638888889,77.2032416666667'),
    ('28.6341694444444,77.2170472222222', '28.6336555555556,77.2060722222222'),
    ('28.6288166666667,77.2082305555556', '28.6429888888889,77.2029111111111'),
    ('28.6470361111111,77.2179194444444', '28.6306388888889,77.2218166666667'),
    ('28.6300027777778,77.2137722222222', '28.6470361111111,77.2179194444444'),
    ('28.6437472222222,77.2275805555556', '28.6279972222222,77.222375'),
    ('28.6372333333333,77.2119694444444', '28.6437472222222,77.2275805555556'),
    ('28.6404611111111,77.2315166666667', '28.6290972222222,77.2265972222222'),
    ('28.6290972222222,77.2265972222222', '28.6427027777778,77.2271583333333'),
    ('28.6340972222222,77.2410305555556', '28.6187027777778,77.23585'),
    ('28.6143611111111,77.2399888888889', '28.6340972222222,77.2410305555556'),
    ('28.6084527777778,77.2399416666667', '28.6155694444444,77.229575'),
    ('28.6100583333333,77.2327555555556', '28.6242555555556,77.2407527777778'),
    
    # Exit pairs
    ('28.5941861111111,77.2429888888889', '28.6084333333333,77.2336638888889'),
    ('28.602275,77.2315166666667', '28.5941861111111,77.2429888888889'),
    ('28.5815722222222,77.2298527777778', '28.5998777777778,77.2282416666667'),
    ('28.5927083333333,77.2391777777778', '28.5815722222222,77.2298527777778'),
    ('28.5798222222222,77.2249388888889', '28.5892611111111,77.2131194444444'),
    ('28.592525,77.2379138888889', '28.5892611111111,77.2131194444444'),
    ('28.5796611111111,77.2116027777778', '28.5981055555556,77.2188277777778'),
    ('28.5974361111111,77.2111972222222', '28.5981055555556,77.2188277777778'),
    ('28.5786722222222,77.1899833333333', '28.5950861111111,77.1961694444445'),
    ('28.5950861111111,77.1961694444445', '28.5786722222222,77.1899833333333'),
    ('28.580225,77.1796416666667', '28.5971055555556,77.1906444444444'),
    ('28.5971055555556,77.1906444444444', '28.580225,77.1796416666667'),
    ('28.6090944444444,77.17265', '28.5953972222222,77.1959722222222'),
    ('28.6092611111111,77.1908888888889', '28.5953972222222,77.1959722222222'),
    ('28.5954805555556,77.168375', '28.6095361111111,77.1910666666667'),
    ('28.6095361111111,77.1910666666667', '28.5954805555556,77.168375'),
    ('28.6337277777778,77.1894861111111', '28.6237555555556,77.2005277777778'),
    ('28.6237555555556,77.2005277777778', '28.6353861111111,77.2012361111111')    
]

def fetch_duration_in_traffic(origin, destination):
    """Fetches duration in traffic from Google Maps Directions API."""
    params = {
        'origin': origin,
        'destination': destination,
        'key': API_KEY,
        'departure_time': 'now',
        'traffic_model': 'best_guess'
    }
    response = requests.get('https://maps.googleapis.com/maps/api/directions/json', params=params)
    data = response.json()
    
    # Parsing the duration in traffic
    duration_in_traffic = data['routes'][0]['legs'][0]['duration_in_traffic']['text']
    return duration_in_traffic

def main():
    results = []
    for origin, destination in locations:
        traffic_info = fetch_duration_in_traffic(origin, destination)
        results.append({
            "Origin": origin,
            "Destination": destination,
            "Duration in Traffic": traffic_info
        })
        print(f"Duration from {origin} to {destination} is {traffic_info}")
    
    # Create a DataFrame
    df = pd.DataFrame(results)
    
    # Get current timestamp for the filename
    timestamp = datetime.now().strftime("%d-%m-%Y %H-%M")
    filename = f"traffic_data_{timestamp}.xlsx"
    
    # Save the DataFrame to an Excel file
    df.to_excel(filename, index=False, engine='openpyxl')

if __name__ == "__main__":
    main()
